<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<html lang="fr">
	<head>
		<title>Connexion</title>
		<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
		<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/node-forge@1.0.0/dist/forge.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.13.0/css/all.css">

		<style>
			@import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');

			#divAll {
				display: flex;
				justify-content: center;
				width: 80%;
				border-radius: 15px;
				box-shadow: 10px 5px 5px rgba(0, 0, 0, 0.455); 
			}

			#divLeft {
				background-color: aqua; 
				width: 50%; 
				border-radius: 15px 0 0 15px;
				text-align: center;
			}

			#divRightConnect {
				background-color: white; 
				width: 50%; 
				border-radius: 0 15px 15px 0;
				text-align: center;
			}

			#divRightCreateAccount {
				background-color: white; 
				width: 50%; 
				border-radius: 0 15px 15px 0;
				text-align: center;
				display: none;
			}

			.social-media{
				display: flex;
				flex-wrap: wrap;
				justify-content: space-between;
				align-items: center;
				margin: 0 auto 20px auto;
				width: 60%;
				max-width: 200px;
			}

			.social-media i{
				padding: 5px;
				border-radius: 100%;
				border: 1px solid black;
				cursor: pointer;
			}

			@media only screen and (max-width: 767px) {
				/* Masquer l'élément avec l'ID titreTopBar sur les écrans de petite taille */
				#titreTopBar {
					display: none;
				}

				#divLeft {
					display: none;
				}

				#divRightConnect {
                    width: 100%;
					border-radius: 15px;
                }

				#divRightCreateAccount {
					width: 100%;
					border-radius: 15px;
				}
			}
		</style>

        <link rel="icon" href="../Images/logo_home_page.png" type="image/png">
	</head>
	<body style="background-color: #F2F2F2;">
		<div style="display: flex; justify-content: space-between; margin: 5px 15px 0 5px;">
			<a style="color: black; text-decoration: none;" href="../index.html">
				<div class="elementMenuAccueil" style="display: flex; align-items: center; cursor: pointer;">
					<img id="logoTopBar" src="../Images/logo_home_page.png" style="width: 60px; height: 60px;">
					<p id="titreTopBar" style="font-weight: bold; font-size: x-large; margin-left: 20px;">
						Gabin221.github.io
					</p>
				</div>
			</a>
			<div style="display: flex; align-items: center;">
				<div style="display: flex; align-items: center; justify-content: center;">
					<svg id="lightSvg" style="width: 30px; height: 30px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
						<path d="M20,11H23V13H20V11M1,11H4V13H1V11M13,1V4H11V1H13M4.92,3.5L7.05,5.64L5.63,7.05L3.5,4.93L4.92,3.5M16.95,5.63L19.07,3.5L20.5,4.93L18.37,7.05L16.95,5.63M12,6A6,6 0 0,1 18,12C18,14.22 16.79,16.16 15,17.2V19A1,1 0 0,1 14,20H10A1,1 0 0,1 9,19V17.2C7.21,16.16 6,14.22 6,12A6,6 0 0,1 12,6M14,21V22A1,1 0 0,1 13,23H11A1,1 0 0,1 10,22V21H14M11,18H13V15.87C14.73,15.43 16,13.86 16,12A4,4 0 0,0 12,8A4,4 0 0,0 8,12C8,13.86 9.27,15.43 11,15.87V18Z" />
					</svg>
					<svg id="buttonSwitch" onclick="darkMode()" style="width: 40px; height: 40px; margin-left: 8px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
						<path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
					</svg>
					<svg id="darkSvg" style="width: 30px; height: 30px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
						<path d="M12 2A9.91 9.91 0 0 0 9 2.46A10 10 0 0 1 9 21.54A10 10 0 1 0 12 2Z" />
					</svg>
				</div>
			</div>
		</div>

		<div style="margin-top: 50px; display: flex; justify-content: center;">
			<div id="divAll">
				<div id="divLeft">
					text
				</div>
				<div id="divRightConnect">
					<h3 style="margin: 40px 0 20px 0;">Se connecter</h3>

					<!-- <div class="social-media">
						<i class="fab fa-google"></i>
						<i class="fab fa-facebook"></i>
						<i class="fab fa-twitter"></i>
						<i class="fab fa-github"></i>
					</div>

					<p><b>OU</b></p> -->

					<form id="loginFormConnect" style="margin: 0 40px 0 40px;">
						<label for="email">Pseudo</label><br>
						<input style="width: 90%;" type="text" id="pseudo" name="pseudo" placeholder="Pseudo">
						<br><br>
						<label for="password">Mot de passe</label><br>
						<input style="width: 90%;" type="password" id="motDePasse" name="password" placeholder="Mot de passe">
						<br><br>
						<input type="submit" value="Se connecter">
					</form>

					<p onclick="clickCreateAccount()" style="margin: 20px 0 20px 0; color: rgb(26, 80, 179); cursor: pointer;">Créer un compte</p>
				</div>
				<div id="divRightCreateAccount">
					<h3 style="margin: 40px 0 20px 0;">Créer un compte</h3>

					<p id="messageErreur" style="color: red; display: none; width: 80%; margin: 10px auto 20px auto;">Veuillez saisir un mot de passe avec au moins 5 caractères.</p>

					<!-- <div class="social-media">
						<i class="fab fa-google"></i>
						<i class="fab fa-facebook"></i>
						<i class="fab fa-twitter"></i>
						<i class="fab fa-github"></i>
					</div>

					<p><b>OU</b></p> -->

					<form id="loginFormCreateAccount" style="margin: 0 40px 0 40px;">
						<label id="pseudoCreateLabel" for="email">Pseudo</label><br>
						<input style="width: 90%;" type="text" id="pseudoCreate" name="pseudo" placeholder="Choisissez votre pseudo">
						<br><br>
						<label id="motDePasseCreateLabel" for="password">Mot de passe</label><br>
						<input style="width: 90%;" type="password" id="motDePasseCreate" name="password" placeholder="Choisissez votre mot de passe">
						<p style="color: rgb(118, 118, 118); width: 90%; margin: 5px auto auto 4%; text-align: left; font-size: 0.7lh;">Au moins 5 caractères.</p>
						<br><br>
						<input type="submit" value="Créer un compte">
					</form>

					<p onclick="clickSeConnecter()" style="margin: 20px 0 20px 0; color: rgb(26, 80, 179); cursor: pointer;">Se connecter</p>
				</div>
			</div>
		</div>

		<script src="../Scripts/hbvebvhezvkbzjvkzjv.js"></script>

		<script>
			var compteur = 1;
			
			function darkMode() {

				if (compteur%2 === 0) {
					// lightmode
					darkModeAll()
					document.getElementById("divRightConnect").style.backgroundColor = "white";
					document.getElementById("divRightCreateAccount").style.backgroundColor = "white";
					document.querySelectorAll('h3, label').forEach(function(element) {
						element.style.color = "black";
					});
					compteur += 1;
				} else {
					// darkmode
					darkModeAll()
					document.getElementById("divRightConnect").style.backgroundColor = "black";
					document.getElementById("divRightCreateAccount").style.backgroundColor = "black";
					document.querySelectorAll('h3, label').forEach(function(element) {
						element.style.color = "white";
					});
					compteur += 1;
				}
		    }
		</script>

		<script>
			function darkModeAll() {
				if (compteur%2 === 0) {
					// lightmode
					document.getElementById('titreTopBar').style.color="black";
					document.getElementById('buttonSwitch').innerHTML = '<svg style="width: 40px; height: 40px; margin-left: 8px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>';
					document.getElementById('lightSvg').innerHTML = '<svg style="width: 30px; height: 30px; margin-left: 8px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11H23V13H20V11M1,11H4V13H1V11M13,1V4H11V1H13M4.92,3.5L7.05,5.64L5.63,7.05L3.5,4.93L4.92,3.5M16.95,5.63L19.07,3.5L20.5,4.93L18.37,7.05L16.95,5.63M12,6A6,6 0 0,1 18,12C18,14.22 16.79,16.16 15,17.2V19A1,1 0 0,1 14,20H10A1,1 0 0,1 9,19V17.2C7.21,16.16 6,14.22 6,12A6,6 0 0,1 12,6M14,21V22A1,1 0 0,1 13,23H11A1,1 0 0,1 10,22V21H14M11,18H13V15.87C14.73,15.43 16,13.86 16,12A4,4 0 0,0 12,8A4,4 0 0,0 8,12C8,13.86 9.27,15.43 11,15.87V18Z" /></svg>';
					document.getElementById('darkSvg').innerHTML = '<svg style="width: 30px; height: 30px; margin-left: 8px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A9.91 9.91 0 0 0 9 2.46A10 10 0 0 1 9 21.54A10 10 0 1 0 12 2Z" /></svg>';
					document.getElementById("logoTopBar").setAttribute("src", "../Images/logo_home_page.png");
					document.body.style.backgroundColor = "#F2F2F2";
				} else {
					// darkmode
					document.getElementById('titreTopBar').style.color="white";
					document.getElementById('buttonSwitch').innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>toggle-switch-outline</title><path d="M17 6H7C3.69 6 1 8.69 1 12S3.69 18 7 18H17C20.31 18 23 15.31 23 12S20.31 6 17 6M17 16H7C4.79 16 3 14.21 3 12S4.79 8 7 8H17C19.21 8 21 9.79 21 12S19.21 16 17 16M17 9C15.34 9 14 10.34 14 12S15.34 15 17 15 20 13.66 20 12 18.66 9 17 9Z" style="fill: white;" /></svg>';
					document.getElementById('lightSvg').innerHTML = '<svg style="width: 30px; height: 30px; margin-left: 8px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11H23V13H20V11M1,11H4V13H1V11M13,1V4H11V1H13M4.92,3.5L7.05,5.64L5.63,7.05L3.5,4.93L4.92,3.5M16.95,5.63L19.07,3.5L20.5,4.93L18.37,7.05L16.95,5.63M12,6A6,6 0 0,1 18,12C18,14.22 16.79,16.16 15,17.2V19A1,1 0 0,1 14,20H10A1,1 0 0,1 9,19V17.2C7.21,16.16 6,14.22 6,12A6,6 0 0,1 12,6M14,21V22A1,1 0 0,1 13,23H11A1,1 0 0,1 10,22V21H14M11,18H13V15.87C14.73,15.43 16,13.86 16,12A4,4 0 0,0 12,8A4,4 0 0,0 8,12C8,13.86 9.27,15.43 11,15.87V18Z" style="fill: white;" /></svg>';
					document.getElementById('darkSvg').innerHTML = '<svg style="width: 30px; height: 30px; margin-left: 8px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A9.91 9.91 0 0 0 9 2.46A10 10 0 0 1 9 21.54A10 10 0 1 0 12 2Z" style="fill: white;" /></svg>';
					document.getElementById("logoTopBar").setAttribute("src", "../Images/logo_home_page_dark.png");
					document.body.style.backgroundColor = "black";
				}
			}
		</script>

		<script>
			function clickCreateAccount() {
				document.getElementById("divRightConnect").style.display = "none";
				document.getElementById("divRightCreateAccount").style.display = "block";
			}

			function clickSeConnecter() {
				document.getElementById("divRightConnect").style.display = "block";
				document.getElementById("divRightCreateAccount").style.display = "none";
			}
		</script>

		<script>
			function logout() {
				sessionStorage.removeItem('userLoggedIn');
				sessionStorage.removeItem('currentUser');
				sessionStorage.removeItem('userRights');
				var previousPage = sessionStorage.getItem('previousPage');
				if (previousPage) {
					window.location.href = previousPage;
				} else {
					window.location.href = '../index.html';
				}
			}

			function encryptPassword(password) {
				var md = forge.md.sha256.create();
				md.update(password);
				return md.digest().toHex();
			}

			function encryptData(data, key) {
				return CryptoJS.AES.encrypt(data, key).toString();
			}

			function decryptData(data, key) {
				var bytes = CryptoJS.AES.decrypt(data, key);
				return bytes.toString(CryptoJS.enc.Utf8);
			}

			document.getElementById('loginFormConnect').addEventListener('submit', function(event) {
				event.preventDefault();

				var pseudo = document.getElementById('pseudo').value;
				var motDePasse = document.getElementById('motDePasse').value;
				var hashedPassword = encryptPassword(motDePasse);
				var usersRef = db.collection('user_gabinsbar');
				
				usersRef.where('id', '==', pseudo).where('motdepasse', '==', hashedPassword).get()
					.then((querySnapshot) => {
						if (!querySnapshot.empty) {
							querySnapshot.forEach((doc) => {
								var userData = doc.data();
								var droits = userData.droits;
								var encryptionKey = 'secretKey'; // Utilisez une clé plus sécurisée et gérée de manière appropriée

								sessionStorage.setItem('userLoggedIn', encryptData('true', encryptionKey));
								sessionStorage.setItem('currentUser', encryptData(pseudo, encryptionKey));
								sessionStorage.setItem('userRights', encryptData(droits, encryptionKey));

								var previousPage = sessionStorage.getItem('previousPage');
								if (previousPage) {
									window.location.href = previousPage;
								} else {
									window.location.href = '../index.html';
								}
							});
						} else {
							alert('Les informations de connexion sont incorrectes. Veuillez réessayer.');
						}
					})
					.catch((error) => {
						console.error('Erreur lors de la vérification des informations de connexion:', error);
					});
			});

			document.getElementById('loginFormCreateAccount').addEventListener('submit', function(event) {
				event.preventDefault();

				var pseudo = document.getElementById('pseudoCreate').value;
				var motDePasse = document.getElementById('motDePasseCreate').value;

				if (motDePasse.length > 4) {
					var hashedPassword = encryptPassword(motDePasse);
					var usersRef = db.collection('user_gabinsbar');

					usersRef.where('id', '==', pseudo).get()
						.then((querySnapshot) => {
							if (querySnapshot.empty) {
								usersRef.add({
									id: pseudo,
									motdepasse: hashedPassword,
									droits: "invite",
								})
								.then((docRef) => {
									console.log("Nouveau compte utilisateur créé avec l'ID: ", docRef.id);
									window.location.href = '../login.html';
								})
								.catch((error) => {
									console.error("Erreur lors de la création du compte utilisateur: ", error);
								});
							} else {
								alert('Le pseudo est déjà utilisé. Veuillez en choisir un autre.');
							}
						})
						.catch((error) => {
							console.error('Erreur lors de la vérification du pseudo existant:', error);
						});
				} else {
					document.getElementById("messageErreur").style.display = "block";
				}
			});

			function getSessionData(item) {
				var encryptionKey = 'secretKey'; // La même clé utilisée pour chiffrer
				var encryptedData = sessionStorage.getItem(item);
				if (encryptedData) {
					return decryptData(encryptedData, encryptionKey);
				}
				return null;
			}
		</script>
	</body>
</html>
